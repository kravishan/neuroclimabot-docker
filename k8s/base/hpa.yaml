# ============================================================================
# Horizontal Pod Autoscaler (HPA) Configuration
# ============================================================================
# Automatically scales deployments based on CPU/memory metrics
# Requires metrics-server to be installed in the cluster
#
# Installation (if needed):
#   kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
#
# Verify metrics-server:
#   kubectl top nodes
#   kubectl top pods -n uoulu
# ============================================================================

---
# ============================================================================
# HPA for Server (Backend API)
# ============================================================================
# Scales: 2-4 replicas based on CPU utilization
# Target: 70% CPU utilization
# Use case: Handles API requests, authentication, chat endpoints
# ============================================================================

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: neuroclima-server-hpa
  namespace: uoulu
  labels:
    app: neuroclima
    component: server
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: neuroclima-server
  minReplicas: 2
  maxReplicas: 4
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300  # Wait 5 minutes before scaling down
      policies:
      - type: Percent
        value: 50  # Scale down max 50% of pods at a time
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0  # Scale up immediately
      policies:
      - type: Percent
        value: 100  # Can double pods at once
        periodSeconds: 15
      - type: Pods
        value: 2  # Or add 2 pods at once
        periodSeconds: 15
      selectPolicy: Max  # Use the policy that scales faster

---
# ============================================================================
# HPA for Processor (Document Processing)
# ============================================================================
# Scales: 2-3 replicas based on CPU utilization
# Target: 70% CPU utilization
# Use case: Heavy document processing, GraphRAG operations
# Note: Limited to 3 replicas due to high memory usage (5Gi per pod)
# ============================================================================

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: neuroclima-processor-hpa
  namespace: uoulu
  labels:
    app: neuroclima
    component: processor
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: neuroclima-processor
  minReplicas: 2
  maxReplicas: 3
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 75
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 600  # Wait 10 minutes before scaling down (processing may be slow)
      policies:
      - type: Pods
        value: 1  # Scale down 1 pod at a time
        periodSeconds: 120
    scaleUp:
      stabilizationWindowSeconds: 60  # Wait 1 minute to confirm high load
      policies:
      - type: Pods
        value: 1  # Add 1 pod at a time (due to high memory)
        periodSeconds: 60

---
# ============================================================================
# HPA for Unstructured API (Document Parsing)
# ============================================================================
# Scales: 2-3 replicas based on CPU utilization
# Target: 70% CPU utilization
# Use case: Unstructured.io API for document parsing
# ============================================================================

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: neuroclima-unstructured-hpa
  namespace: uoulu
  labels:
    app: neuroclima
    component: unstructured
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: neuroclima-unstructured
  minReplicas: 2
  maxReplicas: 3
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Pods
        value: 1
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 30
      policies:
      - type: Pods
        value: 1
        periodSeconds: 30

---
# ============================================================================
# HPA for Client (Frontend)
# ============================================================================
# Scales: 2-4 replicas based on CPU utilization
# Target: 60% CPU utilization (lower threshold for frontend)
# Use case: Nginx serving React frontend, static assets
# ============================================================================

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: neuroclima-client-hpa
  namespace: uoulu
  labels:
    app: neuroclima
    component: client
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: neuroclima-client
  minReplicas: 2
  maxReplicas: 4
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 60
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 75
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 2
        periodSeconds: 15
      selectPolicy: Max

---
# ============================================================================
# USAGE NOTES:
# ============================================================================
# 1. Apply HPA configurations:
#    kubectl apply -f k8s/base/hpa.yaml
#
# 2. Verify HPAs are created:
#    kubectl get hpa -n uoulu
#
# 3. Check HPA status and current metrics:
#    kubectl describe hpa neuroclima-server-hpa -n uoulu
#
# 4. Watch HPA in real-time:
#    kubectl get hpa -n uoulu --watch
#
# 5. If metrics show <unknown>, ensure metrics-server is installed:
#    kubectl get deployment metrics-server -n kube-system
#
# 6. To disable autoscaling temporarily, delete the HPA:
#    kubectl delete hpa neuroclima-server-hpa -n uoulu
#    (The deployment will remain at current replica count)
#
# 7. Adjust thresholds based on observed metrics:
#    kubectl top pods -n uoulu
#    (Check actual CPU/memory usage and tune accordingly)
# ============================================================================
