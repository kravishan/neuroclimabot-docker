apiVersion: v1
kind: ConfigMap
metadata:
  name: client-runtime-env
  namespace: uoulu
data:
  inject-env.sh: |
    #!/bin/sh
    set -e

    echo "Injecting runtime environment variables..."

    # Find all JS files in the assets directory
    find /usr/share/nginx/html/assets -name '*.js' -type f | while read -r file; do
      echo "Processing: $file"

      # Replace hardcoded localhost URLs with relative paths
      sed -i 's|http://localhost:8000/api|/api|g' "$file"
      sed -i 's|http://localhost:5000|/processor|g' "$file"
      sed -i 's|https://YOUR_DOMAIN/api|/api|g' "$file"
      sed -i 's|https://YOUR_DOMAIN/processor|/processor|g' "$file"
    done

    echo "Runtime environment variables injected successfully!"

    # Start nginx
    exec nginx -g 'daemon off;'
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: neuroclima-client
  namespace: uoulu
  labels:
    app: neuroclima
    component: client
spec:
  replicas: 1
  selector:
    matchLabels:
      app: neuroclima
      component: client
  template:
    metadata:
      labels:
        app: neuroclima
        component: client
    spec:
      initContainers:
      - name: inject-runtime-env
        image: docker.io/raviyah/neuroclima-client:latest
        command: ["/bin/sh"]
        args:
        - -c
        - |
          # Copy files to shared volume
          cp -r /usr/share/nginx/html/* /app/

          # Replace hardcoded URLs in JavaScript files
          echo "Injecting runtime environment variables..."
          find /app/assets -name '*.js' -type f 2>/dev/null | while read -r file; do
            echo "Processing: $file"
            sed -i 's|http://localhost:8000/api|/api|g' "$file" || true
            sed -i 's|http://localhost:5000|/processor|g' "$file" || true
            sed -i 's|https://YOUR_DOMAIN/api|/api|g' "$file" || true
            sed -i 's|https://YOUR_DOMAIN/processor|/processor|g' "$file" || true
          done
          echo "Runtime environment injection complete!"
        volumeMounts:
        - name: app-volume
          mountPath: /app
      containers:
      - name: client
        image: nginx:alpine
        ports:
        - containerPort: 80
          name: http
        volumeMounts:
        - name: app-volume
          mountPath: /usr/share/nginx/html
        - name: nginx-config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: app-volume
        emptyDir: {}
      - name: nginx-config
        configMap:
          name: client-nginx-config
