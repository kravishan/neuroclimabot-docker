# ============================================================================
# NeuroClima Client Deployment - Production Configuration
# ============================================================================
# This deployment uses Traefik IngressRoute for routing:
#
# Architecture:
#   Internet → Traefik LB (TLS termination) → Path-based routing:
#         bot.neuroclima.eu/          → neuroclima-client (Frontend)
#         bot.neuroclima.eu/server    → neuroclima-server (Backend API)
#         bot.neuroclima.eu/processor → neuroclima-processor (Document Processing)
#
# Production Features:
#   ✅ 2 replicas for high availability and load distribution
#   ✅ Pod anti-affinity to spread across nodes
#   ✅ Readiness/liveness probes for health checks
#   ✅ No CORS issues - Everything on same domain
#   ✅ TLS termination via Traefik with Let's Encrypt
#
# Environment Variables (Optional):
#   - These override the defaults set in config.js
#   - Default values: /server and /processor (relative paths)
# ============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: neuroclima-client
  namespace: uoulu
  labels:
    app: neuroclima
    component: client
spec:
  replicas: 2  # Production: 2 replicas for high availability and load distribution
  selector:
    matchLabels:
      app: neuroclima
      component: client
  template:
    metadata:
      labels:
        app: neuroclima
        component: client
    spec:
      # Pod anti-affinity: Spread replicas across different nodes for HA
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: component
                  operator: In
                  values:
                  - client
              topologyKey: kubernetes.io/hostname
      containers:
      - name: client
        image: docker.io/raviyah/neuroclima-client:latest
        imagePullPolicy: Always  # Force pull latest image (important for :latest tag)
        ports:
        - containerPort: 80
          name: http
        env:
        # Optional: Override default paths (already set to these values in config.js)
        # These are injected at runtime via docker-entrypoint.sh if specified
        - name: VITE_API_BASE_URL
          value: "/server"  # Default: /server (routes to backend API)
        - name: VITE_API_DOCUMENT_URL
          value: "/processor"  # Default: /processor (routes to document processor)
        - name: VITE_TRANSLATE_API_URL
          value: "/processor"  # Routes translation API through processor
        - name: VITE_STP_SERVICE_URL
          value: "/processor"  # Routes STP service through processor
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
        # Readiness probe: Check if nginx is ready to serve traffic
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 3
        # Liveness probe: Check if container is alive and healthy
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 15
          periodSeconds: 20
          timeoutSeconds: 3
          successThreshold: 1
          failureThreshold: 3
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: nginx-config
        configMap:
          name: client-nginx-config
