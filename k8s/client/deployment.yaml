# ============================================================================
# NeuroClima Client Deployment - Nginx Gateway Architecture
# ============================================================================
# This deployment uses an industry-standard reverse proxy pattern:
#
# Architecture:
#   Internet → ngrok → Nginx Gateway → Path-based routing:
#                           ↓
#         /          → neuroclima-client (Frontend)
#         /server/*  → neuroclima-server (Backend API)
#         /processor/* → neuroclima-processor (Document Processing)
#
# Benefits:
#   ✅ Single entry point - One URL for all services
#   ✅ No CORS issues - Everything on same domain
#   ✅ Production-ready - Industry standard pattern
#   ✅ Easy to scale - Add services by adding paths
#   ✅ Works without domain - Use with ngrok, NodePort, or LoadBalancer
#
# Environment Variables (Optional):
#   - These override the defaults set in config.js
#   - Default values: /server and /processor (relative paths)
#   - Only change if you need custom routing
# ============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: neuroclima-client
  namespace: uoulu
  labels:
    app: neuroclima
    component: client
spec:
  replicas: 2
  selector:
    matchLabels:
      app: neuroclima
      component: client
  template:
    metadata:
      labels:
        app: neuroclima
        component: client
    spec:
      # Pod anti-affinity to spread replicas across different nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: neuroclima
                  component: client
              topologyKey: kubernetes.io/hostname
      containers:
      - name: client
        image: docker.io/raviyah/neuroclima-client:latest
        imagePullPolicy: Always  # Force pull latest image (important for :latest tag)
        ports:
        - containerPort: 80
          name: http
        env:
        # Optional: Override default paths (already set to these values in config.js)
        # These are injected at runtime via docker-entrypoint.sh if specified
        - name: VITE_API_BASE_URL
          value: "/server"  # Default: /server (routes to backend API)
        - name: VITE_API_DOCUMENT_URL
          value: "/processor"  # Default: /processor (routes to document processor)
        - name: VITE_TRANSLATE_API_URL
          value: "/processor"  # Routes translation API through processor
        - name: VITE_STP_SERVICE_URL
          value: "/processor"  # Routes STP service through processor
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        # Health checks
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 2
          failureThreshold: 2
      volumes:
      - name: nginx-config
        configMap:
          name: client-nginx-config
