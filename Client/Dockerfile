# Multi-stage build for React + Vite application
FROM node:20-alpine AS builder

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm install

# Copy application files
COPY . .

# Accept build arguments for ALL Vite environment variables
# API Configuration
ARG VITE_API_BASE_URL
ARG VITE_API_DOCUMENT_URL
ARG VITE_API_TIMEOUT
# External Services
ARG VITE_TRANSLATE_API_URL
ARG VITE_STP_SERVICE_URL
ARG VITE_PROCESSOR_URL
# Application Configuration
ARG VITE_APP_NAME
ARG VITE_APP_VERSION
ARG VITE_APP_ENVIRONMENT
# Feature Flags
ARG VITE_ENABLE_VOICE_MODEL
ARG VITE_ENABLE_GRAPH_VISUALIZATION
ARG VITE_ENABLE_ANALYTICS
ARG VITE_ENABLE_ADMIN_DASHBOARD
# External Services
ARG VITE_LANGSMITH_ENABLED
ARG VITE_FEEDBACK_FORM_URL
ARG VITE_DASHBOARD_URL
# Session Configuration
ARG VITE_SESSION_TIMEOUT_MINUTES
ARG VITE_INACTIVITY_WARNING_MINUTES
# UI Configuration
ARG VITE_DEFAULT_LANGUAGE
ARG VITE_SUPPORTED_LANGUAGES
# Dashboard Configuration
ARG VITE_DASHBOARD_REFRESH_INTERVAL
ARG VITE_DASHBOARD_AUTO_REFRESH
# Authentication
ARG VITE_AUTH_ENABLED

# Set ALL environment variables for the build
# API Configuration
ENV VITE_API_BASE_URL=${VITE_API_BASE_URL}
ENV VITE_API_DOCUMENT_URL=${VITE_API_DOCUMENT_URL}
ENV VITE_API_TIMEOUT=${VITE_API_TIMEOUT}
# External Services
ENV VITE_TRANSLATE_API_URL=${VITE_TRANSLATE_API_URL}
ENV VITE_STP_SERVICE_URL=${VITE_STP_SERVICE_URL}
ENV VITE_PROCESSOR_URL=${VITE_PROCESSOR_URL}
# Application Configuration
ENV VITE_APP_NAME=${VITE_APP_NAME}
ENV VITE_APP_VERSION=${VITE_APP_VERSION}
ENV VITE_APP_ENVIRONMENT=${VITE_APP_ENVIRONMENT}
# Feature Flags
ENV VITE_ENABLE_VOICE_MODEL=${VITE_ENABLE_VOICE_MODEL}
ENV VITE_ENABLE_GRAPH_VISUALIZATION=${VITE_ENABLE_GRAPH_VISUALIZATION}
ENV VITE_ENABLE_ANALYTICS=${VITE_ENABLE_ANALYTICS}
ENV VITE_ENABLE_ADMIN_DASHBOARD=${VITE_ENABLE_ADMIN_DASHBOARD}
# External Services
ENV VITE_LANGSMITH_ENABLED=${VITE_LANGSMITH_ENABLED}
ENV VITE_FEEDBACK_FORM_URL=${VITE_FEEDBACK_FORM_URL}
ENV VITE_DASHBOARD_URL=${VITE_DASHBOARD_URL}
# Session Configuration
ENV VITE_SESSION_TIMEOUT_MINUTES=${VITE_SESSION_TIMEOUT_MINUTES}
ENV VITE_INACTIVITY_WARNING_MINUTES=${VITE_INACTIVITY_WARNING_MINUTES}
# UI Configuration
ENV VITE_DEFAULT_LANGUAGE=${VITE_DEFAULT_LANGUAGE}
ENV VITE_SUPPORTED_LANGUAGES=${VITE_SUPPORTED_LANGUAGES}
# Dashboard Configuration
ENV VITE_DASHBOARD_REFRESH_INTERVAL=${VITE_DASHBOARD_REFRESH_INTERVAL}
ENV VITE_DASHBOARD_AUTO_REFRESH=${VITE_DASHBOARD_AUTO_REFRESH}
# Authentication
ENV VITE_AUTH_ENABLED=${VITE_AUTH_ENABLED}

# Build the application with environment variables
RUN npm run build

# Production stage with nginx
FROM nginx:alpine

# Copy built assets from builder
COPY --from=builder /app/dist /usr/share/nginx/html

# Copy custom nginx configuration
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Expose port 80
EXPOSE 80

# Start nginx
CMD ["nginx", "-g", "daemon off;"]
